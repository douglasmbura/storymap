<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>StoryMap Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #map { width: 50%; height: 100vh; }
    #story { width: 50%; height: 100vh; overflow-y: auto; padding: 1rem; box-sizing: border-box; }
    .chapter { margin-bottom: 2rem; border-bottom: 1px solid #ccc; padding-bottom: 1rem; }
    .chapter h2 { margin-top: 0; }
    .media-viewer { position: relative; text-align: center; }
    .media-viewer img { max-width: 100%; max-height: 300px; display: block; margin: 0 auto; }
    .nav-btn { margin: 5px; padding: 5px 10px; font-size: 14px; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="story"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const storyContainer = document.getElementById('story');

// Function to try loading images sequentially (chapter1_1.jpg, chapter1_2.jpg, ...)
function loadMedia(prefix, mediaContainer) {
  let index = 1;
  const images = [];

  const loadNext = () => {
    const img = new Image();
    const src = `photos/${prefix}_${index}.jpg`;
    img.src = src;
    img.onload = () => {
      images.push(src);
      index++;
      loadNext();
    };
    img.onerror = () => {
      if (images.length > 0) {
        setupViewer(images, mediaContainer);
      } else {
        mediaContainer.innerHTML = "<p><em>No media available.</em></p>";
      }
    };
  };
  loadNext();
}

// Function to setup image viewer with navigation
function setupViewer(images, container) {
  let current = 0;

  const imgElement = document.createElement('img');
  imgElement.src = images[current];

  const prevBtn = document.createElement('button');
  prevBtn.textContent = 'Previous';
  prevBtn.className = 'nav-btn';
  prevBtn.onclick = () => {
    current = (current - 1 + images.length) % images.length;
    imgElement.src = images[current];
  };

  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'Next';
  nextBtn.className = 'nav-btn';
  nextBtn.onclick = () => {
    current = (current + 1) % images.length;
    imgElement.src = images[current];
  };

  const viewer = document.createElement('div');
  viewer.className = 'media-viewer';
  viewer.appendChild(imgElement);
  viewer.appendChild(prevBtn);
  viewer.appendChild(nextBtn);

  container.appendChild(viewer);
}

// Load CSV and build story
fetch('story.csv')
  .then(res => res.text())
  .then(csv => {
    const data = Papa.parse(csv, { header: true }).data;

    data.forEach((row, i) => {
      const chapterDiv = document.createElement('div');
      chapterDiv.className = 'chapter';

      const title = document.createElement('h2');
      title.textContent = row['Chapter'];
      chapterDiv.appendChild(title);

      const desc = document.createElement('p');
      desc.textContent = row['Description'];
      chapterDiv.appendChild(desc);

      const mediaDiv = document.createElement('div');
      chapterDiv.appendChild(mediaDiv);

      const prefix = `chapter${i + 1}`;
      loadMedia(prefix, mediaDiv);

      storyContainer.appendChild(chapterDiv);

      // Add marker
      if (row['Latitude'] && row['Longitude']) {
        const lat = parseFloat(row['Latitude']);
        const lon = parseFloat(row['Longitude']);
        if (!isNaN(lat) && !isNaN(lon)) {
          const marker = L.marker([lat, lon])
            .addTo(map)
            .bindPopup(`<strong>${row['Chapter']}</strong>`);
        }
      }
    });

    // Zoom to first location
    const first = data[0];
    if (first && first['Latitude'] && first['Longitude']) {
      const lat = parseFloat(first['Latitude']);
      const lon = parseFloat(first['Longitude']);
      if (!isNaN(lat) && !isNaN(lon)) {
        map.setView([lat, lon], 8);
      }
    }
  });
</script>

</body>
</html>
