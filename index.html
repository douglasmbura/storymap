<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic StoryMap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
    }

    #map {
      width: 50%;
      height: 100vh;
    }

    #story {
      width: 50%;
      height: 100vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding: 1rem;
      background: #f9f9f9;
      box-sizing: border-box;
    }

    .chapter {
      margin-bottom: 3rem;
      padding: 1rem;
      border-left: 4px solid transparent;
      transition: border-color 0.3s, background 0.3s;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .chapter.active {
      border-color: #0078A8;
      background: #e6f4f9;
    }

    .chapter h2 {
      margin: 0 0 0.5rem;
    }

    .media-viewer {
      position: relative;
      text-align: center;
      margin-top: 0.5rem;
    }

    .media-viewer img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 6px;
    }

    .nav-btn {
      margin: 5px;
      padding: 6px 12px;
      font-size: 14px;
      background: #0078A8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .nav-btn:hover {
      background: #005f85;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="story"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const map = L.map('map', { zoomControl: true }).setView([0, 0], 2);

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' });
const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '© Esri'
});
osm.addTo(map);

const baseMaps = {
  "OpenStreetMap": osm,
  "Esri Satellite": esri
};
L.control.layers(baseMaps).addTo(map);

const storyContainer = document.getElementById('story');
let chapterElements = [];

function loadMedia(prefix, mediaContainer) {
  let index = 1;
  const images = [];

  const loadNext = () => {
    const img = new Image();
    const src = `photos/${prefix}_${index}.jpg`;
    img.src = src;
    img.onload = () => {
      images.push(src);
      index++;
      loadNext();
    };
    img.onerror = () => {
      if (images.length > 0) {
        setupViewer(images, mediaContainer);
      } else {
        mediaContainer.innerHTML = "<p><em>No media available.</em></p>";
      }
    };
  };
  loadNext();
}

function setupViewer(images, container) {
  let current = 0;
  const imgElement = document.createElement('img');
  imgElement.src = images[current];

  const prevBtn = document.createElement('button');
  prevBtn.textContent = 'Previous';
  prevBtn.className = 'nav-btn';
  prevBtn.onclick = () => {
    current = (current - 1 + images.length) % images.length;
    imgElement.src = images[current];
  };

  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'Next';
  nextBtn.className = 'nav-btn';
  nextBtn.onclick = () => {
    current = (current + 1) % images.length;
    imgElement.src = images[current];
  };

  const viewer = document.createElement('div');
  viewer.className = 'media-viewer';
  viewer.appendChild(imgElement);
  viewer.appendChild(prevBtn);
  viewer.appendChild(nextBtn);

  container.appendChild(viewer);
}

function activateChapter(index, lat, lon, zoom) {
  map.setView([lat, lon], zoom || 10);
  chapterElements.forEach((el, i) => {
    if (i === index) {
      el.classList.add('active');
    } else {
      el.classList.remove('active');
    }
  });
}

fetch('story.csv')
  .then(res => res.text())
  .then(csv => {
    const data = Papa.parse(csv, { header: true }).data;

    data.forEach((row, i) => {
      const chapterDiv = document.createElement('div');
      chapterDiv.className = 'chapter';

      const title = document.createElement('h2');
      title.textContent = row['Chapter'];
      chapterDiv.appendChild(title);

      const desc = document.createElement('p');
      desc.textContent = row['Description'];
      chapterDiv.appendChild(desc);

      const mediaDiv = document.createElement('div');
      chapterDiv.appendChild(mediaDiv);
      loadMedia(`chapter${i + 1}`, mediaDiv);

      storyContainer.appendChild(chapterDiv);
      chapterElements.push(chapterDiv);

      const lat = parseFloat(row['Latitude']);
      const lon = parseFloat(row['Longitude']);
      const zoom = parseInt(row['Zoom']) || 10;

      if (!isNaN(lat) && !isNaN(lon)) {
        L.marker([lat, lon]).addTo(map).bindPopup(`<strong>${row['Chapter']}</strong>`);
      }

      // Add observer to track chapter in view
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            activateChapter(i, lat, lon, zoom);
          }
        });
      }, { threshold: 0.5 });

      observer.observe(chapterDiv);
    });

    // Set initial view
    const first = data[0];
    if (first && first['Latitude'] && first['Longitude']) {
      map.setView([parseFloat(first['Latitude']), parseFloat(first['Longitude'])], parseInt(first['Zoom']) || 8);
    }
  });
</script>
</body>
</html>
